/**
 * angular-oauth2-frontend - Un cliente OAuth2
 * @author practian
 * @version v1.0.0
 * @link 
 * @license ISC
 */
!function(){var oauth2=angular.module("pi.oauth2");oauth2.directive("oauth2LoginButton",function(oauth2Service,$log){return{scope:{state:"="},link:function(scope,element,attrs){oauth2Service.createLoginUrl(scope.state).then(function(url){console.log("scope.state="+scope.state),console.log("url="+url),element.attr("onclick","location.href='"+url+"'")}).catch(function(error){throw $log.error("oauth2LoginButton-directive error"),$log.error(error),error})}}})}(),function(){angular.module("pi.oauth2",[])}();var app=angular.module("pi.oauth2");app.service("oauth2Service",function($document,$window,$timeout,$q,$location,$http,$log,$state){this.clientId="",this.redirectUri="",this.loginUrl="",this.scope="",this.rngUrl="",this.oidcUrl="",this.routersUrl="",this.createLoginUrl=function(additionalState){var that=this;return"undefined"==typeof additionalState&&(additionalState=""),this.createAndSaveNonce().then(function(state){additionalState&&(state+=";"+additionalState);var response_type="token",url=that.loginUrl+"?response_type="+response_type+"&client_id="+encodeURIComponent(that.clientId)+"&state="+encodeURIComponent(state);return that.redirectUri&&(url+="&redirect_uri="+encodeURIComponent(that.redirectUri)),that.scope&&(url+="&scope="+encodeURIComponent(that.scope)),url})},this.tryLogin=function(){console.log("estoy en tryLogin");var parts=this.getFragment(),accessToken=parts.access_token,state=parts.state;if(!accessToken||!state)return!1;var savedNonce=localStorage.getItem("nonce"),stateParts=state.split(";");if(savedNonce===stateParts[0]){var params={accessToken:accessToken};localStorage.setItem("access_token",JSON.stringify(params));var expiresIn=parts.expires_in;if(expiresIn){expiresInMilliSeconds=1e3*parseInt(expiresIn);var now=new Date,expiresAt=now.getTime()+expiresInMilliSeconds;localStorage.setItem("expires_at",expiresAt)}return stateParts.length>1&&(this.state=stateParts[1]),""!==this.oidcUrl&&$http.get(this.oidcUrl).then(function(result){var claimsJson=JSON.stringify(result.data);localStorage.setItem("id_token_claims_obj",claimsJson)},function(err){console.log("Error in getUserInfo():"+JSON.stringify(err))}),""!==this.routersUrl&&$http.get(this.routersUrl).then(function(collection){var collectiont=JSON.stringify(collection);localStorage.setItem("collection",collectiont)}),!0}return!1},this.getAccessToken=function(){return localStorage.getItem("access_token")},this.getIdentityClaims=function(){var claims=localStorage.getItem("id_token_claims_obj");return claims?JSON.parse(claims):null},this.getRouters=function(){var claims=localStorage.getItem("collection");return claims?JSON.parse(claims):null},this.isAauthenticated=function(){if(this.getAccessToken()){var expiresAt=localStorage.getItem("expires_at"),now=new Date;return!(expiresAt&&parseInt(expiresAt)<now.getTime())}return!1},this.logOut=function(){console.log("logOut en oauth2"),localStorage.removeItem("access_token"),localStorage.removeItem("id_token_claims_obj"),localStorage.removeItem("collection")},this.createAndSaveNonce=function(){return this.createNonce().then(function(nonce){return localStorage.setItem("nonce",nonce),nonce})},this.createNonce=function(){for(var text="",possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<20;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return console.log("text="+text),$q.when(text)},this.getFragment=function(){return console.log("hash="+window.location.hash.substr(1)),console.log("window.location.search="+window.location.search),window.location.search.indexOf("error")!=-1&&(console.log("error"),this.logOut()),0===window.location.hash.indexOf("#")?this.parseQueryString(window.location.hash.substr(1)):{}},this.parseQueryString=function(queryString){var pairs,pair,separatorIndex,escapedKey,escapedValue,key,value,data={};if(null===queryString)return data;pairs=queryString.split("&");for(var i=0;i<pairs.length;i++)pair=pairs[i],separatorIndex=pair.indexOf("="),separatorIndex===-1?(escapedKey=pair,escapedValue=null):(escapedKey=pair.substr(0,separatorIndex),escapedValue=pair.substr(separatorIndex+1)),key=decodeURIComponent(escapedKey),value=decodeURIComponent(escapedValue),"/"===key.substr(0,1)&&(key=key.substr(1)),data[key]=value;return data}}),app.factory("oauth2InterceptorService",function($injector,$q,$location,$window,$rootScope){var _request=function(configs){configs.headers=configs.headers||{};var authData=localStorage.getItem("access_token");if(authData){var a=JSON.parse(authData);configs.headers.Authorization="Bearer "+a.accessToken}return configs},_responseError=function(rejection){var loggedIn=!1,authData=localStorage.getItem("access_token");if(authData&&(loggedIn=!0),console.log("rejection info:"+JSON.stringify(rejection)),511===rejection.status||401===rejection.status){var oauth2Service=$injector.get("oauth2Service");oauth2Service.logOut();var userService=$injector.get("userService");userService.userName=null,$location.url("/catalogo/401_unauthorized"),console.log("error 511: "+rejection.stack)}return 403===rejection.status&&(console.log("error-- 403: "+rejection.stack),$rootScope.$emit("loginRequired")),401===rejection.status&&console.log("error 401: "+rejection.stack),$q.reject(rejection)};return{request:_request,responseError:_responseError}});